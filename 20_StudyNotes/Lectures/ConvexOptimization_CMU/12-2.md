### First-Order Optimality Conditions

#### KKT Conditions

回顾含约束问题(不要求凸)的几何最优性条件: 对于局部最优解 $\mathbf{x}^*$ 和可行域 $\mathcal{X}$, 则任意可行方向 $\mathbf{d}$ 都满足:
$$
\mathbf{d}^\top \nabla f(\mathbf{x}^*) \geq 0, \quad \forall \mathbf{d} \in \mathcal{T}_{\mathcal{X}}(\mathbf{x}^*) \quad (1)
$$

而我们也同样讨论, 这个最优性条件的求解是困难的. 转而我们考虑 Linear Feasible Direction Cone 的定义:
$$
\mathcal{F}(\mathbf{x}^*) = \left\{ \mathbf{d} \in \mathbb{R}^n \mid \mathbf{d}^\top \nabla c_i(\mathbf{x}^*) \geq 0, \forall i \in \mathcal{I} ~;~ \mathbf{d}^\top \nabla c_j(\mathbf{x}^*) = 0, \forall j \in \mathcal{E} \right\} \quad (2)
$$
但也同时指出 $\mathcal{F}(\mathbf{x}^*)$ 并不能直接指定 $\mathbf{x}^*$ 处的最优性条件. 因此我们将验证一些约束品性(Constraint Qualifications), 当 CQ 满足时往往将有 $\mathcal{F}(\mathbf{x}^*) = \mathcal{T}_{\mathcal{X}}(\mathbf{x}^*)$ 作为桥梁. 

因此, 对于既是最优点, 又满足例如 LICQ 的约束品性时, 则 $(1), (2)$ 将同时成立, 故换言之, 下述集合为空集:
$$
\left\{ \mathbf{d} \ \middle| \
\begin{aligned}
\mathbf{d}^\top \nabla f(\mathbf{x}^*) &\lt 0, \\
\mathbf{d}^\top \nabla c_i(\mathbf{x}^*) &\leq 0, \forall i \in \mathcal{I}\cup \mathcal{A}(\mathbf{x}^*) \\
\mathbf{d}^\top \nabla c_j(\mathbf{x}^*) &= 0, \forall j \in \mathcal{E}
\end{aligned}
\right\} = \emptyset
$$

- 这意味着, 在局部最小点 $\mathbf{x}^*$ 处, 不存在一个可行方向 $\mathbf{d}$ 同时满足:
    - 一阶可行 (即后两个条件) , 使得 active set 的约束仍然不违反;
    - $\mathbf{d}^\top \nabla f(\mathbf{x}^*) < 0$ (第一个条件), 即该方向是下降方向.
- 然而这一条件的判断仍然不够直接, 下述引理会进一步改进. 

***Lemma* (Farkas' Lemma)**: 设 $p,q$ 是两个非负整数, 给定向量组 $\left \{ \mathbf{a}_i\in \mathbb{R}^n \right \}_{i=1}^p$ 和 $\left \{ \mathbf{b}_j\in \mathbb{R}^n \right \}_{j=1}^q$, 以及 $\mathbf{c}\in \mathbb{R}^n$, 如下两组命题恰有其一成立:

(1) 存在 $\mathbf{d}\in \mathbb{R}^n$ 使得如下条件同时成立:
- $\mathbf{d}^\top \mathbf{a}_i = 0, \forall i = 1, \ldots, p \quad \text{\small (F.L.1)}$
- $\mathbf{d}^\top \mathbf{b}_j \ge 0, \forall j = 1, \ldots, q \quad \text{\small (F.L.2)}$
- $\mathbf{d}^\top \mathbf{c} < 0 \quad \text{\small (F.L.3)}$

(2) 存在 $\left \{ \lambda_i \right \}_{i=1}^p \in \mathbb{R}$ 和 $\left \{ \mu_j \right \}_{j=1}^q \in \mathbb{R}_{\geq 0}$ 使得:
$$
\mathbf{c} = \sum_{i=1}^p \lambda_i \mathbf{a}_i + \sum_{j=1}^q \mu_j \mathbf{b}_j \quad \text{\small (F.L.4)}
$$

- *Proof*
    - 若 $\text{\small (F.L.4)}$ 成立, 对其左右两侧同时乘以 $\mathbf{d}^\top$, 则有:
        $$
        \mathbf{d}^\top \mathbf{c} = \sum_{i=1}^p \lambda_i \mathbf{d}^\top \mathbf{a}_i + \sum_{j=1}^q \mu_j \mathbf{d}^\top \mathbf{b}_j
        $$
      -  此时对于满足 $\text{\small (F.L.1)}$ 和 $\text{\small (F.L.2)}$ 的 $\mathbf{d}$, 其能推出 $\mathbf{d}^\top \mathbf{c} \geq 0$, 此时证明 $\text{\small (F.L.3)}$ 不成立. 
    - 若 $\text{\small (F.L.1)}\sim \text{\small (F.L.3)}$ 解不存在, 则用反证法结合分离超平面定理, 可以推出 $\text{\small (F.L.4)}$ 成立. 

---

对照前述的集合为空集的条件, 其恰好符合 (1) 中的条件. 因此 Frakas 引理在 imply 既然集合为空, 说明集合中的三个条件不能同时成立, 故必然能够表示成为 $\text{\small (F.L.4)}$ 的形式. 具体地, 取 $\mathbf{c} = -\nabla f(\mathbf{x}^*)$, $\mathbf{a}_i = \nabla c_i(\mathbf{x}^*)$, $\mathbf{b}_j = \nabla c_j(\mathbf{x}^*)$, 则有:
$$
-\nabla f(\mathbf{x}^*) = \sum_{i\in\mathcal{E}} \lambda_i^* \nabla c_i(\mathbf{x}^*) + \sum_{j\in\mathcal{I}\cap \mathcal{A}(\mathbf{x}^*)} \mu_j^* \nabla c_j(\mathbf{x}^*)
$$
- 其中 $\lambda_i^* \in \mathbb{R}, i\in \mathcal{E}$ 和 $\mu_j^* \ge 0, j\in \mathcal{I}\cap \mathcal{A}(\mathbf{x}^*)$. 

若进一步补充, 对于 $j\in \mathcal{I}\setminus \mathcal{A}(\mathbf{x}^*)$ 的部分 (即 inactive 的不等式约束), 令 $\mu_j^* = 0$, 则有:
$$
\begin{aligned}
-\nabla f(\mathbf{x}^*) &= \sum_{i\in\mathcal{E}} \lambda_i^* \nabla c_i(\mathbf{x}^*) + \sum_{j\in\mathcal{I}} \mu_j^* \nabla c_j(\mathbf{x}^*)\\
\mu_j^* c_j(\mathbf{x}^*) &= 0,\quad \forall j\in \mathcal{I}
\end{aligned}
$$
  
  - 其中 $\lambda_i^* \in \mathbb{R}, i\in \mathcal{E}$ 和 $\mu_j^* \ge 0, j\in \mathcal{I}$.

第二个条件 $\mu_j^* c_j(\mathbf{x}^*) = 0, \forall j\in \mathcal{I}$ 也称为 *Complementary Slackness Condition (CSC)*. 

- 其表示对于 inactive 的不等式约束, 其对应的 multiplier 为 $0$; 对于不为 $0$ 的 multiplier, 其约束一定是 active 的 (即 $c_j(\mathbf{x}^*) = 0$).
- 对于 CSC, 若能够保证 $\mu_j^* = 0$ 和 $c_j(\mathbf{x}^*) = 0$ 有且仅有其一成立, 则说明当前的约束是严格互补松弛的 (Strict Complementary Slackness Condition, SCSC). 一般满足 SCSC 的约束的最优点具有良好性质, 算法收敛速度较快.

> [!example] **不满足 SCSC 的例子**
>
> 考虑如下问题:
> $$
> \min_{x\in \mathbb{R}} \quad x^2 ,\quad \text{s.t.} \quad x \leq 0.
> $$
> 最优解是 $x^* = 0$, 并且该位置对于约束来说也是 active 的. 
>
> 另一方面, 考虑 KKT stationarity 条件, 其要求:
> $$
> \nabla f(x^*) + \lambda^* \nabla c(x^*) = 0 \implies (2x^* + \lambda^*) \mid_{x^*=0} = 0 \implies \lambda^* = 0.
> $$
> 综上, 该问题是 active 的, 但同时 $\lambda^* = 0$, 不满足 SCSC. 其直观是, 这个约束虽然卡在边界上, 但并没有阻止目标函数减小. 因为在该点的梯度本来就是 $0$, 本身的便不需要额外的约束来限制梯度. 

---

综上, 总结出如下一阶必要条件, 即 KKT 条件, 并称满足 $(\mathbf{x}^*, \lambda_i^*, \mu_j^*)$ 为 KKT 点.

***Theorem* (KKT Conditions)** 考虑如下约束优化问题 (不要求是凸的):
$$
\begin{aligned}
\min_{\mathbf{x}\in \mathbb{R}^n} & \quad f(\mathbf{x}) \\
\text{subject to} & \quad c_i(\mathbf{x}) \leq 0, i\in \mathcal{I} \\
& \quad c_j(\mathbf{x}) = 0, j\in \mathcal{E}
\end{aligned}
$$
对于局部最优解 $\mathbf{x}^* \in \mathcal{X}$, 若 $\mathcal{T}_{\mathcal{X}}(\mathbf{x}^*) = \mathcal{F}(\mathbf{x}^*)$ 成立, 则存在 Lagrange Multiplier $\lambda_i^*, \mu_j^*$ 使得如下条件成立:
$$
\begin{aligned}
&\text{\small{Stationarity:}}  &&  \nabla f(\mathbf{x}^*) + \sum_{i\in\mathcal{E}} \lambda_i^* \nabla c_i(\mathbf{x}^*) + \sum_{j\in\mathcal{I}\cap \mathcal{A}(\mathbf{x}^*)} \mu_j^* \nabla c_j(\mathbf{x}^*) = 0\\
&\text{\small{Primal Feasibility 1:}}  && c_i(\mathbf{x}^*) \leq 0, \quad \forall i\in \mathcal{I} \\
&\text{\small{Primal Feasibility 2:}}  && c_j(\mathbf{x}^*) = 0, \quad \forall j\in \mathcal{E} \\
&\text{\small{Dual Feasibility:}} &&  \mu_j^* \geq 0, \quad \forall j\in \mathcal{I} \\
&\text{\small{Complementary Slackness:}} &&  \mu_j^* c_j(\mathbf{x}^*) = 0, \quad \forall j\in \mathcal{I}
\end{aligned}
$$
- 这里的 Stationarity 条件是前述的 Farkas' Lemma 的直接推论, 其就代表了最优点处, 不存在一个可行方向使得目标函数再减小且满足约束. 一般也将其记为 $\nabla_{\mathbf{x}} L(\mathbf{x}^*, \lambda_i^*, \mu_j^*) = 0$.

- 需要指出, 该条件成立是建立在 $\mathcal{T}_{\mathcal{X}}(\mathbf{x}^*) = \mathcal{F}(\mathbf{x}^*)$ 成立的前提下的. 因此, 在实际应用中, 需要结合约束品性 (Constraint Qualifications) 来判断是否满足 KKT 条件. 因此 KKT 是一个必要条件, 满足 KKT 条件并不一定是最优点. 


### Second-Order Optimality Conditions

对于上述 KKT 中的 Stationarity 条件, 回顾前述的 Farkas' Lemma, Stationarity 条件成立就等价于 $\mathbf{d}^\top \nabla f(\mathbf{x}^*) \geq 0, \forall \mathbf{d} \in \mathcal{F}(\mathbf{x}^*)$ (类比 $y=x^3$ 的这种鞍点, 其排除所有能够在一阶情况下让目标函数减小的可行方向). 下面需要通过二阶最优性条件来进一步判断最优点.

***Definition* (Critical Cone)**: 设 $(\mathbf{x}^*, \lambda_i^*, \mu_j^*)$ 是 KKT 点, 其 Critical Cone 定义为:
$$
\mathcal{C}(\mathbf{x}^*; \lambda_i^*, \mu_j^*) = \left\{ \mathbf{d} \in \mathcal{F}(\mathbf{x}^*) \mid \nabla c_j(\mathbf{x}^*)^\top \mathbf{d} = 0, ~ \mu_j^* \gt 0,~  \forall j \in \mathcal{A}(\mathbf{x}^*) \cap \mathcal{I}\right\}
$$

- Critical Cone 的 intuition 如下:
    - 作为 $\mathcal{F}(\mathbf{x}^*)$ 的子集, 其表示在等式约束下 $\nabla c_j(\mathbf{x}^*)^\top \mathbf{d} = 0,~ i \in \mathcal{E}$; 在活跃不等式约束下 $\nabla c_j(\mathbf{x}^*)^\top \mathbf{d} \leq 0,~ j \in \mathcal{A}(\mathbf{x}^*) \cap \mathcal{I}$.
    - 同时, 由于满足 KKT 的 Stationarity 条件, 等式左右同乘 $\mathbf{d}^\top$, 有:
        $$
        \mathbf{d}^\top \nabla f(\mathbf{x}^*) + \sum_{i\in\mathcal{E}} \lambda_i^* \mathbf{d}^\top \nabla c_i(\mathbf{x}^*) + \sum_{j\in\mathcal{I}} \mu_j^* \mathbf{d}^\top \nabla c_j(\mathbf{x}^*) = 0
        $$
        - 由 $\mathcal{F}(\mathbf{x}^*)$ 的定义, 全部的等式约束均有 $\mathbf{d}^\top \nabla c_j(\mathbf{x}^*) = 0$; 由互补松弛性全部的非活跃不等式约束均有 $\mu_j^* = 0$. 综合后, 得到
            $$
            \mathbf{d}^\top \nabla f(\mathbf{x}^*) + \sum_{j\in\mathcal{I}\cap \mathcal{A}(\mathbf{x}^*)} \mu_j^* \mathbf{d}^\top \nabla c_j(\mathbf{x}^*) = 0 \quad (\dagger)
            $$
        - 分析该条件, 已知 $\mu_j^* \ge 0$, $\nabla c_j(\mathbf{x}^*)^\top \mathbf{d} \leq 0$, 因此 $\mathbf{d}^\top \nabla f(\mathbf{x}^*) \geq 0$.

    - 综上, 由 KKT + $\mathcal{F}(\mathbf{x}^*)$ 的定义, 目前得到的集合为 $\{ \mathbf{d} \in \mathcal{F}(\mathbf{x}^*) \mid \mathbf{d}^\top \nabla f(\mathbf{x}^*) \geq 0 \}$.  即所有一阶线性可行方向上, 目标的一阶变化都不可能是负的. 既然如此, 进一步讨论两种情况:
        - 若 $\nabla f(\mathbf{x}^*)^\top \mathbf{d} \gt 0$, 说明一阶情况下该方向立即会导致目标函数增加, 故可以直接忽略;
        - 若 $\nabla f(\mathbf{x}^*)^\top \mathbf{d} = 0$, 说明该方向是一阶线性可行方向, 但是否能够在完整情况下同样确保最小, 这是在之前的一阶条件下没办法判断, 而需要进一步研究的. 
    - 因此在概念上, Critical Cone 即在上述基础上, 提取 $\nabla f(\mathbf{x}^*)^\top \mathbf{d} = 0$ 的那些方向作为二阶情况研究的基本对象. 但进一步, 在 critical cone 中的实际定义为给定 $\nabla c_j(\mathbf{x}^*)^\top \mathbf{d} = 0,~ \mu_j^* \gt 0,~  \forall j \in \mathcal{A}(\mathbf{x}^*) \cap \mathcal{I}$ 的那些方向, 下面将说明这两个命题是等价的.
        - 根据 $(\dagger)$ 式, 可以得到 $\nabla f(\mathbf{x}^*)^\top \mathbf{d} = - \sum_{j\in\mathcal{I}\cap \mathcal{A}(\mathbf{x}^*)} \mu_j^* \nabla c_j(\mathbf{x}^*)^\top \mathbf{d}$. 故欲让 $\nabla f(\mathbf{x}^*)^\top \mathbf{d} = 0$, 则需要 RHS 的$- \sum_{j\in\mathcal{I}\cap \mathcal{A}(\mathbf{x}^*)} \mu_j^* \nabla c_j(\mathbf{x}^*)^\top \mathbf{d} = 0$, 即要求全部 $\mu_j^* \gt 0$ 的不等式约束都满足 $\nabla c_j(\mathbf{x}^*)^\top \mathbf{d} = 0$.
    - 综上, critical cone 就是在讨论线性化可行方向中, 那些根据一阶梯度信息无法判断是否为上升下降方向的线性化可行方向. 

