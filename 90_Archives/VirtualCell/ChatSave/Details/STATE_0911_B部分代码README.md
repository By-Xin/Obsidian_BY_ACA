# VCC STATE é¢„æµ‹æµæ°´çº¿æœ€ç»ˆç‰ˆæœ¬æ€»ç»“

**ç”Ÿæˆæ—¶é—´**: 2025-09-11  
**çŠ¶æ€**: å·²æµ‹è¯•é€šè¿‡  
**ç›®æ ‡**: ç”Ÿæˆç¬¦åˆVCCè§„èŒƒçš„æäº¤æ–‡ä»¶

## æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### ğŸŸ¢ ä¸»è¦æµæ°´çº¿æ–‡ä»¶ï¼ˆå·²éªŒè¯ï¼‰

#### 1. B1 - éªŒè¯æ•°æ®åˆ†æ
**æ–‡ä»¶**: `b1_analyze_validation_perturbations.py`  
**åŠŸèƒ½**: åˆ†æ`pert_counts_Validation.csv`ï¼Œè®¡ç®—ç»†èƒåˆ†é…ç­–ç•¥  
**è¾“å‡º**: `perturbation_allocation_plan.csv`, `allocation_summary.txt`  
**çŠ¶æ€**: âœ… å·²éªŒè¯é€šè¿‡  
**å…³é”®å‚æ•°**:
- `max_cells=100000` (æ€»ç»†èƒæ•°é™åˆ¶)
- `ctrl_percentage=0.08` (8%æ§åˆ¶ç»†èƒ)
- é»˜è®¤è·¯å¾„: `/data/home/sczd425/run/xinby/cell-eval/vcc_data/pert_counts_Validation.csv`

#### 2. B2 - æ§åˆ¶ç»†èƒå‡†å¤‡  
**æ–‡ä»¶**: `b2_prepare_control_cells.py`  
**åŠŸèƒ½**: ä»è®­ç»ƒæ•°æ®æŠ½æ ·æ§åˆ¶ç»†èƒï¼Œæ”¯æŒåˆ†å±‚æŠ½æ ·  
**è¾“å‡º**: `sampled_control_cells.h5ad`, `control_cells_summary.txt`  
**çŠ¶æ€**: âœ… å·²éªŒè¯é€šè¿‡  
**å…³é”®ä¿®æ­£**: 
- æ‰¹æ¬¡åˆ—åå…¼å®¹æ€§ï¼šä¼˜å…ˆ`batch`ï¼Œå›è½`batch_var`
- åˆ†å±‚æŠ½æ ·ç¡®ä¿æ‰¹æ¬¡ä»£è¡¨æ€§
- é»˜è®¤æŠ½æ ·8000ä¸ªæ§åˆ¶ç»†èƒ

#### 3. B3 - STATEæ¨¡å‹æ¨ç†
**æ–‡ä»¶**: `b3_state_inference_practical.py`  
**åŠŸèƒ½**: ä½¿ç”¨è®­ç»ƒå¥½çš„STATEæ¨¡å‹è¿›è¡Œæ¨ç†é¢„æµ‹  
**è¾“å‡º**: `state_predictions.h5ad` (60,751ä¸ªæ‰°åŠ¨ç»†èƒ)  
**çŠ¶æ€**: âœ… å·²éªŒè¯é€šè¿‡  
**å…³é”®ä¿®æ­£**:
- ç¨€ç–çŸ©é˜µå¤„ç†ï¼šä½¿ç”¨`scipy.sparse.vstack`é¿å…å†…å­˜çˆ†ç‚¸
- checkpointåç§°ï¼š`step=17000-val_loss=6.7711.ckpt`
- ç»å¯¹è·¯å¾„ï¼š`/data/home/sczd425/run/xinby/state/state/scratch/gpu_sbatch_run`

#### 4. B4 - æ•°æ®ç»„è£…ï¼ˆå¿«é€Ÿç‰ˆæœ¬ï¼‰
**æ–‡ä»¶**: `b4_quick_fix.py` â­ **æ¨èä½¿ç”¨**  
**åŠŸèƒ½**: å°†STATEè¾“å‡ºä¸æ§åˆ¶ç»†èƒåˆå¹¶ä¸ºæœ€ç»ˆæäº¤æ ¼å¼  
**è¾“å‡º**: `vcc_prediction_final.h5ad` (~68,751ä¸ªç»†èƒ)  
**çŠ¶æ€**: âœ… å·²éªŒè¯é€šè¿‡  
**å…³é”®ä¿®æ­£**:
- AnnDataå…¼å®¹æ€§ï¼šå¤„ç†`obs_names_unique()`ç‰ˆæœ¬å·®å¼‚
- é«˜æ•ˆåˆå¹¶ï¼šä½¿ç”¨`ad.concat`é¿å…å†…å­˜é—®é¢˜
- æ•°æ®ç±»å‹ï¼šç¡®ä¿`float32`æ ¼å¼

#### 5. B5 - æ‰“åŒ…æäº¤
**æ–‡ä»¶**: `b5_package_submission.py`  
**åŠŸèƒ½**: ä½¿ç”¨cell-evalå·¥å…·éªŒè¯å¹¶æ‰“åŒ…ä¸ºVCCæ ¼å¼  
**è¾“å‡º**: `vcc_submission_state_v1.vcc`, æ‘˜è¦æ–‡ä»¶  
**çŠ¶æ€**: âœ… å·²éªŒè¯é€šè¿‡  
**å…³é”®ä¿®æ­£**:
- åŸºå› æ–‡ä»¶æ ¼å¼å¤„ç†ï¼šæ­£ç¡®è¯†åˆ«`gene_names.csv`ç‰¹æ®Šæ ¼å¼
- æ§åˆ¶ç»†èƒéªŒè¯ï¼šç¡®è®¤`non-targeting`å­˜åœ¨
- æ–‡ä»¶è·¯å¾„æ›´æ–°ï¼šæŒ‡å‘æ­£ç¡®çš„æœ€ç»ˆé¢„æµ‹æ–‡ä»¶

### ğŸ”§ è¾…åŠ©å·¥å…·æ–‡ä»¶

- `debug_gene_file.py` - åŸºå› æ–‡ä»¶æ ¼å¼è°ƒè¯•å·¥å…·
- `verify_final_data.py` - æœ€ç»ˆæ•°æ®éªŒè¯å·¥å…·
- `run_vcc_pipeline.py` - ä¸»æ§åˆ¶è„šæœ¬ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰
- `quick_run.sh` - å¿«é€Ÿæ‰§è¡Œè„šæœ¬

### âŒ å†—ä½™æ–‡ä»¶ï¼ˆå¯åˆ é™¤ï¼‰

- `b3_state_inference.py` - B3åŸå§‹ç‰ˆæœ¬ï¼ˆå·²è¢«practicalç‰ˆæœ¬æ›¿ä»£ï¼‰
- `b4_assemble_prediction.py` - B4å®Œæ•´ç‰ˆæœ¬ï¼ˆè¢«quick_fixæ›¿ä»£ï¼Œè¿‡äºå¤æ‚ï¼‰
- å„ç§è°ƒè¯•å’Œä¸´æ—¶æ–‡ä»¶

## ğŸš¨ é‡è¦æ–‡ä»¶ç®¡ç†é—®é¢˜è®°å½•

### é—®é¢˜æè¿°
**ä½ç½®**: `/data/home/sczd425/run/xinby/state/state/scratch/`  
**é—®é¢˜**: ç›®å½•ç»“æ„æ··ä¹±ï¼Œè®­ç»ƒäº§ç‰©åˆ†æ•£å­˜å‚¨

**å½“å‰çŠ¶æ€**:
```
scratch/
â”œâ”€â”€ gpu_sbatch_run/           # å®é™…è®­ç»ƒè¾“å‡ºç›®å½•
â”‚   â””â”€â”€ checkpoints/          # æ¨¡å‹checkpoint
â”‚       â””â”€â”€ step=17000-val_loss=6.7711.ckpt
â”œâ”€â”€ config.yaml              # ä»gpu_sbatch_runç§»å‡ºçš„é…ç½®æ–‡ä»¶
â”œâ”€â”€ batch_onehot_map.pkl     # ä»gpu_sbatch_runç§»å‡ºçš„æ•°æ®æ–‡ä»¶
â”œâ”€â”€ cell_type_onehot_map.pkl # ä»gpu_sbatch_runç§»å‡ºçš„æ•°æ®æ–‡ä»¶
â”œâ”€â”€ data_module.torch        # ä»gpu_sbatch_runç§»å‡ºçš„æ•°æ®æ–‡ä»¶
â”œâ”€â”€ pert_onehot_map.pt      # ä»gpu_sbatch_runç§»å‡ºçš„æ•°æ®æ–‡ä»¶
â””â”€â”€ var_dims.pkl            # ä»gpu_sbatch_runç§»å‡ºçš„æ•°æ®æ–‡ä»¶
```

**æ ¹æœ¬åŸå› **: ä¸ºäº†è®©B3æ¨ç†è„šæœ¬æ­£å¸¸è¿è¡Œï¼Œå¿…é¡»å°†`gpu_sbatch_run`å†…çš„æ•°æ®æ–‡ä»¶ç§»åˆ°ä¸Šçº§ç›®å½•

**å½±å“**: 
- ç›®å½•ç»“æ„ä¸è§„èŒƒ
- éš¾ä»¥ç®¡ç†å¤šä¸ªè®­ç»ƒå®éªŒ
- ç‰ˆæœ¬æ§åˆ¶å›°éš¾

**å»ºè®®ä¿®æ­£** (æš‚ä¸å®æ–½):
1. ä¿®æ”¹STATEæ¨¡å‹åŠ è½½é€»è¾‘ï¼Œæ­£ç¡®å¤„ç†å­ç›®å½•ç»“æ„
2. æˆ–è€…è§„èŒƒåŒ–åœ°å°†æ‰€æœ‰è®­ç»ƒäº§ç‰©ä¿æŒåœ¨`gpu_sbatch_run`å†…
3. æ›´æ–°B3è„šæœ¬çš„æ–‡ä»¶æŸ¥æ‰¾é€»è¾‘

**å½“å‰è§£å†³æ–¹æ¡ˆ**: 
- æ¥å—ç°çŠ¶ï¼Œè®°å½•é—®é¢˜
- ç¡®ä¿B3è„šæœ¬ä½¿ç”¨æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„
- åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜è¿™ä¸ªéæ ‡å‡†ç»“æ„

## ğŸ’¡ æ‰§è¡Œæµç¨‹

### å®Œæ•´æ‰§è¡Œï¼ˆæ¨èï¼‰
```bash
cd ~/run/xinby/0911

# 1. åˆ†æéªŒè¯æ•°æ®
python b1_analyze_validation_perturbations.py

# 2. å‡†å¤‡æ§åˆ¶ç»†èƒ  
python b2_prepare


_control_cells.py

# 3. STATEæ¨ç†ï¼ˆéœ€åœ¨æ­£ç¡®ç¯å¢ƒä¸­æ‰§è¡Œï¼‰
python b3_state_inference_practical.py

# 4. å¿«é€Ÿç»„è£…ï¼ˆæ·»åŠ æ§åˆ¶ç»†èƒï¼‰
python b4_quick_fix.py

# 5. éªŒè¯ç»“æœ
python verify_final_data.py

# 6. æ‰“åŒ…æäº¤
python b5_package_submission.py
```

### å¿«æ·æ‰§è¡Œ
```bash
# ä½¿ç”¨ä¸»æ§åˆ¶è„šæœ¬
python run_vcc_pipeline.py

# æˆ–ä½¿ç”¨shellè„šæœ¬
./quick_run.sh
```

## ğŸ“‹ è¾“å‡ºæ–‡ä»¶ç»“æ„

```
/data/home/sczd425/run/xinby/vcc_prediction_output/
â”œâ”€â”€ perturbation_allocation_plan.csv         # B1è¾“å‡º
â”œâ”€â”€ allocation_summary.txt                   # B1è¾“å‡º
â”œâ”€â”€ sampled_control_cells.h5ad              # B2è¾“å‡º
â”œâ”€â”€ control_cells_summary.txt               # B2è¾“å‡º
â”œâ”€â”€ state_inference/
â”‚   â””â”€â”€ state_predictions.h5ad              # B3è¾“å‡º
â”œâ”€â”€ vcc_prediction_final.h5ad               # B4è¾“å‡º
â””â”€â”€ submission/
    â”œâ”€â”€ vcc_submission_state_v1.vcc         # B5æœ€ç»ˆæäº¤æ–‡ä»¶
    â”œâ”€â”€ submission_summary.txt              # B5æ‘˜è¦
    â””â”€â”€ submission_checklist.txt            # B5æ£€æŸ¥æ¸…å•
```

## âœ… éªŒè¯æ£€æŸ¥æ¸…å•

- [x] æ€»ç»†èƒæ•° â‰¤ 100,000 (å®é™… ~68,751)
- [x] åŸºå› æ•°é‡ = 18,080  
- [x] åŒ…å«`target_gene`åˆ—
- [x] åŒ…å«`non-targeting`æ§åˆ¶ç»†èƒ (~8,000)
- [x] æ•°æ®ç±»å‹ä¸º`float32`
- [x] æ–‡ä»¶é€šè¿‡`cell-eval prep`å¤„ç†
- [x] `.vcc`æ–‡ä»¶æˆåŠŸåˆ›å»º
- [x] åŸºå› é¡ºåºä¸è®­ç»ƒæ•°æ®ä¸€è‡´

## ğŸ¯ æäº¤å‡†å¤‡

1. **æœ€ç»ˆæ–‡ä»¶**: `/data/home/sczd425/run/xinby/vcc_submission/vcc_submission_state_v1.vcc`
2. **ä¸Šä¼ åœ°å€**: https://virtualcellchallenge.org/  
3. **éªŒè¯æ–¹æ³•**: è¿è¡Œ`verify_final_data.py`ç¡®è®¤æ•°æ®å®Œæ•´æ€§

---

**æ³¨æ„**: æœ¬æµæ°´çº¿å·²å®Œæ•´æµ‹è¯•ï¼Œæ‰€æœ‰æ­¥éª¤éƒ½å·²éªŒè¯é€šè¿‡ã€‚æ–‡ä»¶ç®¡ç†é—®é¢˜ä¸å½±å“é¢„æµ‹ç»“æœçš„æ­£ç¡®æ€§ã€‚