## 竞赛任务

- **Virtual Cell Challenge (VCC)** 要求你写一个模型，输入“未受到干扰的细胞转录组”并指定一个 **gene perturbation**（基因扰动，常见做法是 CRISPR-i 敲低某个基因），输出该扰动后该细胞总体的 **转录响应**——也就是每个基因的表达变化
- 数据按 **train / validation / test** 三份发布，验证集只有 200 个扰动（你已全部拿到），用来本地或者上传 leaderboard 即时评估；测试集 100 个扰动在比赛后期解锁决定最终排名
---
下面用统计语言建模. 首先约定记号:

- $G$: 全基因总数 ($\approx 18000$). 对应基因索引 $g \in \{1,\cdots, G\}$
- $N_{pert}$: 要预测的 perturbation 数量 ($N_{pert}^{\text{val}}= 200$)
- $Y = [y_{kg}]\in\mathbb{R}^{N_{pert}\times G}$: 真实值, 第 $k$ 个扰动在第 $g$ 个基因上的 *pseudobulk* 表达
	- **Pseudobulk**: 认为对于同一个基因进行 perturb 得到的多个基因相当于是重复实验, 因此可以对这些细胞进行聚合以求均值等. 
	- **基因表达**: 
		- 假设我们对于细胞 $i=1,\dots,M$, 关于基因 $g=1,\dots,G$ 的观测计数为 $C_{ig}\in\mathbb N_0$. 定义细胞 $i$ 的总 reads (library size) 为 $s_i \;=\;\sum_{g=1}^{G} C_{ig}$. 由于技术原因, 不同细胞之间的 $s_i$ 差距很大. 因此需要进行归一化. 
		- **Total-Count (CPM/TP10K) 归一化**: $X_{ig}=\frac{C_{ig}}{s_i}c_0$ , 且通常 $c_0 := 10000$. 
		- **Log-transformation**: 进一步进行对数处理以稳定方差. 得到最终的表达数据 $Y_{ig}=\log\bigl(1 + X_{ig}\bigr)$
- $\hat{\mathbf Y} = [\hat y_{kg}]$: 我们提出模型对应的输出. 

为检测预测效果, 我们需要进行 **Differential Expression Test**:
- **研究目的**: 判断扰动 $k$ 是否显著改变了某基因 $g$ 的表达水平
- **统计检验**: 
	- 比较 **两组独立样本**
		- **实验组**: 同一 perturbation $k$ 下的 $M_k$ 个细胞或其 pseudobulk 表达. $\{Y_{kg}^{(i)}\}_{i=1}^{M_k}$
		- **对照组**: non-targeting control 细胞 (NTC), 记为 $C$ 个观测. 类似于宏观上的安慰剂组, 其不会真正 perturb 任何基因. $\{Y_{0g}^{(j)}\}_{j=1}^{C}$
	- 原假设:
		- $H_0:\; F_{kg}(y)=F_{0g}(y),\quad\text{即扰动不改变基因 }g\text{ 的表达分布}$
	- 检验方法 - Wilcoxon Rank Sum Test
		- 把两组观测混在一起排序, 看实验组的秩是否系统性偏大/偏小


---

## VCC 评分指标

### Differential Expression Score (DES)

- 对于每个 perturb $k$, 根据真实的实验数据获得这个 perturb 会显著影响的基因之集合, 记为 $G_{k,\mathrm{true}}=\{g:p_{kg}^{\mathrm{true}}<0.05\}$, 记其个数为 $n_k=\lvert G_{k,\mathrm{true}}\rvert$. 
	- 其中该 $p_{kg}^{\text{true}}$ 是通过上述 W. Rank Sum Test 得到的. 即得到所有接受 $k$ 扰动的细胞 (或 pseudobulk), 以及对应的阴性对照组, 对其表达水平进行假设检验, 得到 p-value. 
	- 此外需要额外控制假阳性比率, 通过额外的统计修正 (此处为 Benjamini–Hochberg 控制 **FDR**), 得到最终的 p-value
- 从模型 perturb 预测之结果中, 同样获取显著性前 $n_k$ 显著的基因, 集合记为 $\tilde G_{k,\mathrm{pred}}=\operatorname{Top}_{n_k}\bigl\{p_{kg}^{\mathrm{pred}}\bigr\}$
- 定义召回率: 在显著受到 perturb 影响的基因中, 预测的 $n_k$ 个和真实实验提示的 $n_k$ 个基因的重复比率. 进一步对所有 perturb 进行求平均, 得到总数据集的效果. $$\mathrm{DES}_k=\frac{\lvert \tilde G_{k,\mathrm{pred}}\cap G_{k,\mathrm{true}}\rvert}{n_k},\quad
\mathrm{DES}=\frac1N\sum_{k=1}^{N}\mathrm{DES}_k$$

### Perturbation Discrimination Score (PDS)

- 对于某个 perturb $l$, 我们有 pseudobulk 向量 $\mathbf{y}_l \in \mathbb{R}^G$. 由于一共有 $N_{pert}$ 种 perturb, 我们有真值库 $\{\mathbf{y}_{1},\dots,\mathbf{y}_{N_{pert}}\}$. 另一方面, 对于每个 perturb, 我们也给出了自己的预测 $\hat{\mathbf{y}}_{k}$.  
- 因此对于给出的预测 $\hat{\mathbf{y}}_{k}$, 我们可以和所有 perturb 的真值计算 Spearman Rank Correlation:
$$\{s_{kl}\}_{l=1}^{N_{pert}}=\{\rho~\!\bigl(\hat{\mathbf y}_k,\mathbf y_l\bigr)\}_{l=1}^{N_{pert} }$$
- 对于预测 $\hat{\mathbf{y}}_{k}$ 得到的关于所有 perturb 的 Sp. Corr 分数 $\{s_{k1},\dots,s_{kN}\}$ 从大到小排序, 找到 $\text{rank}(s_{k=l})$ (即我们关于 $k$ 的预测值在所有真实的扰动中的 Sp.Corr 是第几相关的). 这个排名记为 $r_k$ (其中 $1$ 为最高). 
- 进一步归一化放缩到 0~1 区间, 即得到了我们对 pert $k$ 的估计的 PDS 得分:
  $$\mathrm{PDS}_k = 1-\frac{r_k-1}{N-1} = \frac{N-r_k}{N-1}$$
	- 若 $r_k = 1$, 即我们对 $k$ 的预测的表达结果和所有 pert 中, 同样是 $k$ 的真实实验数据结果最相关, 则 $PDS_k = 1$. 反之若最不相关则为 $PDS_k = 0$. 
- 最后整体得分:
	$$\mathrm{PDS} = \frac{1}{N_{pert}}\sum_{k=1}^{N_{pert}}\mathrm{PDS}_k$$
### Mean Absolute Error
直接在所有基因上比较绝对偏差 (同样为 psedobulk)：
$$\mathrm{MAE}_k=\frac1G\sum_{g=1}^{G}\bigl|\hat y_{kg}-y_{kg}\bigr|,\quad
\mathrm{MAE}=\frac1N\sum_{k=1}^{N}\mathrm{MAE}_k$$

## Replogle-Nadig 数据集

- R-N 是一个大的细胞测序数据集合. 其表达矩阵的行（≈18 k 基因）与 VCC 基本同一张转录组基因表. 
- VCC 中有 200 个目标基因是被敲掉的, 即为所谓的 perturbation (pert 的本质也是基因). 我们在 RN 中同样筛选出了这 200 个 perturb (以及控制组的 non-targeting) 的对应数据, 作为补充. $G_{\mathrm{RN}}^{\mathrm{pert}} \;=\; \bigl\{\,g_1,\ldots,g_{200}\bigr\}\;=\;G_{\mathrm{VCC}}^{\mathrm{pert}}$
- 

## Stat 标准 Baseline

- 设经过归一化以及 log 处理后的数据为 $X\in \mathbb{R}^{C\times G}$, 其中 $C$ 为去除对照组后细胞总数, $G = 18080$ 为基因总数. 
- 每个细胞还对应了一个扰动标签, $t_i \in \{1,2,\ldots,G\}$, 表示第 $i$ 个细胞被敲了 $t_i$ 位置的基因. 
	- 进一步根据这个扰动标签生成一个 indicator 矩阵: $T = [T_{ij}] = \boldsymbol{1}\{j = t_i\} \in \{0,1\}^{C\times G}$. 即, 这个矩阵有 $C$ 行, 每行表示一个细胞. 每个细胞 (每行) 是一个 one-hot 的向量, 其只在被 perturb 的那个位置(第 $i$ 个细胞对应第 $t_i$ 列) 为 1, 其余为 0. 
- 对这个输入数据经过转制后进行 PCA (即关于细胞维度进行整合), 得到 $$G = \text{PCA}_{k}(X^\top)\in \mathbb{R}^{G\times k}$$其中保留 PC 个数为 $k=50$. 相当于我们得到的是每个基因在细胞空间的表达谱 (gene embedding)
	- 同时可以得到这个扰动嵌入矩阵: $$P:= TG\in \mathbb{R}^{C\times k}$$ 即, $P$ 矩阵的第 $i$ 行表示第 $i$ 个细胞的扰动 embedding, 其取值为该 perturb 对应的基因的 embedding vector, 即 $G$ 的第 $t_i$ 行. 
- 同时得到每个基因整合全部细胞的均值: $$b:=\frac{1}{C}X^\top \boldsymbol{1} \in \mathbb{R}^G$$
- 我们给出一个线性拟合: $$\hat{Y} = b \boldsymbol{1}^\top + GWP^\top$$
	- 其中 $W\in\mathbb{R}^{k\times k}$ 为 待学习参数
- 目标函数为: $$\min_W\;\bigl\|Y-b\mathbf{1}^\top-EWP^\top\bigr\|_F^2+\lambda\lVert W\rVert_F^2$$
- 得到封闭解为: $$W=(E^\top E+\lambda I)^{-1}E^\top\,(Y-b\mathbf{1}^\top)\,P\,(P^\top P+\lambda I)^{-1}$$
